<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>万物皆可AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6',
                        secondary: '#64748B',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        light: '#F8FAFC',
                        dark: '#1E293B'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .preview-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
            .btn-hover { @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5; }
            .tag-hover { @apply transition-all duration-200 hover:bg-primary/10 hover:text-primary cursor-pointer; }
            .model-card { @apply border border-gray-200 rounded-xl p-4 cursor-pointer transition-all duration-300 hover:border-primary hover:bg-primary/5 hover:shadow-md; }
            .model-card.active { @apply border-primary bg-primary/5 ring-2 ring-primary/20 shadow-md; }
            .model-card.disabled { @apply opacity-60 cursor-not-allowed; }
            .card-shadow { @apply shadow-md hover:shadow-lg transition-shadow duration-300; }
            .status-dot { @apply w-2 h-2 rounded-full inline-block mr-1; }
        }
    </style>
</head>
<body class="font-inter bg-light text-dark min-h-screen flex flex-col">
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa fa-paint-brush text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">万物皆可AI ~~~ YaHee, Studio. ~~~</h1>
            </div>
            <div class="flex items-center gap-4">
                <div id="creditDisplay" class="flex items-center gap-1 text-sm text-secondary">
                    <i class="fa fa-credit-card text-primary"></i>
                    <span>当前积分: <span id="creditCount">--</span></span>
                </div>
                <button id="apiSettingBtn" class="flex items-center gap-1 text-secondary hover:text-primary btn-hover px-3 py-1.5 rounded-lg">
                    <i class="fa fa-key"></i>
                    <span class="hidden sm:inline">API 设置</span>

                </button>
                <a href="https://ganxiang.xiaoyina.com/quotation/productView" target="_blank" class="flex items-center gap-1 text-secondary hover:text-primary btn-hover px-3 py-1.5 rounded-lg">
                    <i class="fa fa-print"></i>
                    <span class="hidden sm:inline">印刷报价</span>
                </a>
                <a href="https://yaheex.github.io/yahee/baojia.html" target="_blank" class="flex items-center gap-1 text-secondary hover:text-primary btn-hover px-3 py-1.5 rounded-lg">
                    <i class="fa fa-bullhorn"></i>
                    <span class="hidden sm:inline">广告报价</span>
                </a>					
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-xl p-5 shadow-sm card-shadow">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fa fa-upload text-primary"></i>
                        上传参考图片
                    </h2>
                    <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer bg-gray-50">
                        <input type="file" id="imageUpload" accept="image/*" multiple class="hidden">
                        <i class="fa fa-picture-o text-4xl text-gray-400 mb-3"></i>
                        <p class="text-secondary mb-2">点击或拖拽图片至此处上传</p>
                        <p class="text-xs text-gray-500">支持JPG、PNG格式，最多上传5张</p>
                    </div>
                    <div id="previewContainer" class="mt-4 grid grid-cols-3 gap-2 hidden">
                        <h3 class="col-span-3 text-sm font-medium text-gray-600 mb-2">预览图：</h3>
                        <div id="previewList" class="col-span-3 grid grid-cols-3 gap-2"></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-5 shadow-sm card-shadow">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fa fa-comment text-primary"></i>
                        描述词配置
                    </h2>
                    <div class="mb-4">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">预设描述词：</h3>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto pr-1" id="presetTags">
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="提取图案">提取图案</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="增强细节">增强细节</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="完善细节">完善细节</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="增强画质">增强画质</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="保留主体">保留主体</span>
							<span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="高清重绘">高清重绘</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="保留人物">保留人物</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="修复人像">修复人像</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="矫正图形">矫正图形</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="保持一致性">保持一致性</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="按比例扩图">按比例扩图</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="白底黑内容">白底黑内容</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="转为平面图">转为平面图</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="转为线稿图">转为线稿图</span>
							<span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="转为矢量图风格">转为SVG风格</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="去所有文字">去掉所有文字</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="移除背景（白）">移除背景，改为白色背景</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="透明背景（GPT模型有效）">透明背景</span>
							<span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="摄影机拍摄质感">摄影机拍摄质感</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="文字和LOGO变成黑色">文字和LOGO变成黑色</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="改为夜间亮化效果图">改为夜间亮化效果图</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="发光字">发光字</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="发光灯带">发光灯带</span>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="customPrompt" class="block text-sm font-medium text-gray-600 mb-2">自定义描述词：</label>
                        <textarea id="customPrompt" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary" placeholder="请输入图片描述，越详细生成效果越好..."></textarea>
                    </div>
                    <div id="selectedTagsContainer" class="mb-2 hidden">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">已选描述词：</h3>
                        <div id="selectedTags" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-5 shadow-sm card-shadow">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fa fa-sliders text-primary"></i>
                        生成配置
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">选择模型：Banana搞不定的图就选GPT。</label>
                            <div class="grid grid-cols-1 gap-3" id="modelSelector">
                                <div class="model-card" data-model="gpt">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-medium flex items-center">
                                                GPT
                                                <span class="status-dot bg-success ml-2"></span>
                                                <span class="text-xs text-gray-500 ml-1">正常</span>
                                            </h4>
                                            <p class="text-xs text-gray-500 mt-1">超强还原、超强理解能力。1-2分钟出图。400积分/次  ￥0.02~￥0.04/次</p>
                                        </div>
                                        <i class="fa fa-check-circle text-primary hidden"></i>
                                    </div>
                                </div>
                                <div class="model-card active" data-model="banana">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-medium flex items-center">
                                                Banana
                                                <span class="status-dot bg-success ml-2"></span>
                                                <span class="text-xs text-gray-500 ml-1">正常</span>
                                            </h4>
                                            <p class="text-xs text-gray-500 mt-1">超强一致性。30秒左右出图。</p>
                                        </div>
                                        <i class="fa fa-check-circle text-primary"></i>
                                    </div>
                                </div>
                                <div class="model-card" data-model="flux">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-medium flex items-center">
                                                Flux
                                                <span class="status-dot bg-success ml-2"></span>
                                                <span class="text-xs text-gray-500 ml-1">正常</span>
                                            </h4>
                                            <p class="text-xs text-gray-500 mt-1">支持文字、人像、万物高清放大。</p>
                                        </div>
                                        <i class="fa fa-check-circle text-primary hidden"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="gptConfig" class="border-l-4 border-primary pl-4 py-2 hidden">
                            <p class="text-sm text-gray-500">默认生成 1 张图片。</p>
                        </div>

                        <div id="bananaConfig" class="border-l-4 border-primary pl-4 py-2">
                            <div>
                                <label for="bananaSubModel" class="block text-sm font-medium text-gray-600 mb-2">Banana 子模型：</label>
                                <select id="bananaSubModel" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary">
                                    <option value="nano-banana">banana ~~~ 1400积分/次 - ￥0.07~￥0.14/次</option>
                                    <option value="nano-banana-fast" selected>banana-fast ~~~ 440积分/次 - ￥0.022~￥0.044/次</option>
                                </select>
                            </div>
                        </div>

                        <div id="fluxConfig" class="border-l-4 border-primary pl-4 py-2 hidden">
                            <div>
                                <label for="fluxSubModel" class="block text-sm font-medium text-gray-600 mb-2">Flux 子模型：</label>
                                <select id="fluxSubModel" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary">
                                    <option value="flux-kontext-pro" selected>pro ~~~ 700积分/次 - ￥0.035~￥0.07/次</option>
                                    <option value="flux-kontext-max">max ~~~ 1400积分/次 - ￥0.07~￥0.14/次</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">
                                <input type="checkbox" id="forceResolution" class="mr-2" checked>
                                强制完整生成（不裁剪）
                            </label>
                            <p class="text-xs text-gray-500">生成后需手动调整至所需分辨率</p>
                        </div>
                        <div>
                            <label for="imageSize" class="block text-sm font-medium text-gray-600 mb-2">图片比例：</label>
                            <select id="imageSize" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary">
                                <option value="auto">自动</option>
                                <option value="1:1">1:1（正方形）</option>
                                <option value="3:2">3:2（横屏）</option>
                                <option value="2:3">2:3（竖屏）</option>
                                <option value="16:9">16:9（宽屏）</option>
                                <option value="9:16">9:16（竖屏视频）</option>
                                <option value="4:3">4:3（传统电视）</option>
                                <option value="3:4">3:4（竖屏照片）</option>
                                <option value="5:4">5:4（打印照片）</option>
                                <option value="21:9">21:9（电影宽屏）</option>
                            </select>
                        </div>

                        <button id="generateBtn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg btn-hover flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fa fa-magic"></i>
                            <span>开始生成</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-xl p-5 shadow-sm card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fa fa-eye text-primary"></i>
                            生成预览
                        </h2>
                        <div id="generationStatus" class="text-sm text-secondary hidden">
                            <i class="fa fa-spinner fa-spin mr-1"></i>
                            <span>生成中...</span>
                        </div>
                    </div>
                    <div id="previewResult" class="border border-gray-200 rounded-lg p-8 text-center bg-gray-50 min-h-[400px] flex flex-col items-center justify-center">
                        <i class="fa fa-image text-5xl text-gray-300 mb-3"></i>
                        <p class="text-secondary mb-1">生成的图片将显示在这里</p>
                        <p class="text-xs text-gray-500">生成的图片链接有效期为2小时</p>
                    </div>
                    <div id="resultActions" class="mt-4 flex justify-center gap-3 hidden">
                        <button id="downloadBtn" class="bg-success text-white px-4 py-2 rounded-lg btn-hover flex items-center gap-1">
                            <i class="fa fa-download"></i>
                            <span>下载图片</span>
                        </button>
                        <button id="saveHistoryBtn" class="bg-primary text-white px-4 py-2 rounded-lg btn-hover flex items-center gap-1">
                            <i class="fa fa-save"></i>
                            <span>保存到历史</span>
                        </button>
                        <button id="regenerateBtn" class="bg-secondary text-white px-4 py-2 rounded-lg btn-hover flex items-center gap-1">
                            <i class="fa fa-refresh"></i>
                            <span>重新生成</span>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-5 shadow-sm card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fa fa-history text-primary"></i>
                            历史生成记录
                        </h2>
                        <button id="clearHistoryBtn" class="text-sm text-danger hover:underline">清空记录</button>
                    </div>
                    <div id="historyContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        <div class="col-span-full text-center py-8 text-secondary">
                            <i class="fa fa-folder-open-o text-4xl mb-3"></i>
                            <p>暂无历史生成记录</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-5 shadow-sm card-shadow">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fa fa-th-large text-primary"></i>
                        案例展示
                    </h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3" id="casesContainer">
                        <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170801z6GbUq.jpg" title="案例1">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170801z6GbUq.jpg" alt="案例1" class="w-full h-24 object-cover">
                        </div>
						
                        <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170808ubntSM.jpg" title="案例2">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170808ubntSM.jpg" alt="案例2" class="w-full h-24 object-cover">
                        </div>
						
						 <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/17636171708098d5xv1.jpg" title="案例3">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/17636171708098d5xv1.jpg" alt="案例3" class="w-full h-24 object-cover">
                        </div>
						
						 <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170810zjAXwx.jpg" title="案例4">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170810zjAXwx.jpg" alt="案例4" class="w-full h-24 object-cover">
                        </div>
						
						 <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170812GWectp.jpg" title="案例5">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170812GWectp.jpg" alt="案例5" class="w-full h-24 object-cover">
                        </div> 
						
						<div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170813Euc8s6.jpg" title="案例6">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170813Euc8s6.jpg" alt="案例6" class="w-full h-24 object-cover">
                        </div>
						
						 <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170814sNIE8N.jpg" title="案例7">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170814sNIE8N.jpg" alt="案例7" class="w-full h-24 object-cover">
                        </div>
						
						 <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170816vFuguu.jpg" title="案例8">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170816vFuguu.jpg" alt="案例8" class="w-full h-24 object-cover">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 py-4 mt-6">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500">
            <p>YaHee, Studio.</p>
        </div>
    </footer>

    <!-- API 设置模态框 -->
    <div id="apiModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">API 设置</h3>
                <button id="closeApiModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div id="apiKeyList" class="max-h-60 overflow-y-auto">
                    <div class="flex items-center gap-2 mb-2 p-2 border border-gray-200 rounded-lg">
                        <input type="password" class="flex-1 border-none outline-none" placeholder="sk-..." value="">
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">积分: --</span>
                        <button class="text-danger hover:text-red-600">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
                <button id="addApiKeyBtn" class="w-full bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg btn-hover">
                    <i class="fa fa-plus mr-2"></i>添加API Key
                </button>
                <button id="saveApiSetting" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg btn-hover">保存设置</button>
            </div>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div id="imagePreviewModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <button id="closePreviewModal" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300">
            <i class="fa fa-times"></i>
        </button>
        <img id="previewModalImg" src="" alt="放大预览" class="max-w-[90%] max-h-[90vh] object-contain">
    </div>

    <script>
        const appState = {
            uploadedImages: [],
            selectedTags: new Set(),
            generatedImages: [],
            historyImages: JSON.parse(localStorage.getItem('imageHistory')) || [],
            apiKeys: JSON.parse(localStorage.getItem('apiKeys')) || [{ key: '', credits: 0 }],
            selectedApiKeyIndex: 0,
            selectedModel: 'banana',
            selectedBananaSubModel: 'nano-banana-fast',
            historyPage: 1,
            historyPageSize: 8,
            maxCredit: 10000,
            modelStatus: {
                gpt: { status: true, error: '' },
                banana: { status: true, error: '' },
                flux: { status: true, error: '' }
            }
        };

        const elements = {
            uploadArea: document.getElementById('uploadArea'),
            imageUpload: document.getElementById('imageUpload'),
            previewContainer: document.getElementById('previewContainer'),
            previewList: document.getElementById('previewList'),
            presetTags: document.getElementById('presetTags'),
            customPrompt: document.getElementById('customPrompt'),
            selectedTagsContainer: document.getElementById('selectedTagsContainer'),
            selectedTags: document.getElementById('selectedTags'),
            modelSelector: document.getElementById('modelSelector'),
            gptConfig: document.getElementById('gptConfig'),
            bananaConfig: document.getElementById('bananaConfig'),
            bananaSubModel: document.getElementById('bananaSubModel'),
            fluxConfig: document.getElementById('fluxConfig'),
            fluxSubModel: document.getElementById('fluxSubModel'),
            forceResolution: document.getElementById('forceResolution'),
            imageSize: document.getElementById('imageSize'),
            generateBtn: document.getElementById('generateBtn'),
            previewResult: document.getElementById('previewResult'),
            resultActions: document.getElementById('resultActions'),
            downloadBtn: document.getElementById('downloadBtn'),
            saveHistoryBtn: document.getElementById('saveHistoryBtn'),
            regenerateBtn: document.getElementById('regenerateBtn'),
            historyContainer: document.getElementById('historyContainer'),
            apiSettingBtn: document.getElementById('apiSettingBtn'),
            apiModal: document.getElementById('apiModal'),
            closeApiModal: document.getElementById('closeApiModal'),
            apiKeyList: document.getElementById('apiKeyList'),
            addApiKeyBtn: document.getElementById('addApiKeyBtn'),
            saveApiSetting: document.getElementById('saveApiSetting'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            generationStatus: document.getElementById('generationStatus'),
            creditDisplay: document.getElementById('creditDisplay'),
            creditCount: document.getElementById('creditCount'),
            
            // --- 新增元素 ---
            casesContainer: document.getElementById('casesContainer'),
            imagePreviewModal: document.getElementById('imagePreviewModal'),
            closePreviewModal: document.getElementById('closePreviewModal'),
            previewModalImg: document.getElementById('previewModalImg')
        };

        function init() {
            renderApiKeyList();
            elements.bananaSubModel.value = appState.selectedBananaSubModel;
            renderHistory();
            bindEvents();
            updateModelSelection(appState.selectedModel);
            updateCreditDisplay();
            
            if (appState.apiKeys.length > 0 && appState.apiKeys[0].key) {
                fetchAllApiCredits();
            }
        }

        function bindEvents() {
            elements.uploadArea.addEventListener('click', () => elements.imageUpload.click());
            elements.uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.add('border-primary', 'bg-primary/5');
            });
            elements.uploadArea.addEventListener('dragleave', () => {
                elements.uploadArea.classList.remove('border-primary', 'bg-primary/5');
            });
            elements.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.remove('border-primary', 'bg-primary/5');
                if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
            });
            elements.imageUpload.addEventListener('change', (e) => {
                if (e.target.files.length) handleFiles(e.target.files);
            });

            elements.presetTags.addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN' && e.target.dataset.tag) toggleTag(e.target.dataset.tag);
            });

            const modelCards = document.querySelectorAll('.model-card');
            modelCards.forEach(card => {
                card.addEventListener('click', function() {
                    const modelName = this.dataset.model;
                    if (this.classList.contains('active')) return;
                    modelCards.forEach(c => {
                        c.classList.remove('active');
                        c.querySelector('.fa-check-circle').classList.add('hidden');
                    });
                    this.classList.add('active');
                    this.querySelector('.fa-check-circle').classList.remove('hidden');
                    appState.selectedModel = modelName;
                    updateModelSelection(modelName);
                });
            });
            
            elements.bananaSubModel.addEventListener('change', function() {
                appState.selectedBananaSubModel = this.value;
            });

            elements.generateBtn.addEventListener('click', generateImage);

            // --- 修复：下载图片 ---
            elements.downloadBtn.addEventListener('click', () => {
                if (appState.generatedImages.length > 0) {
                    const imageUrl = appState.generatedImages[0].url;
                    const link = document.createElement('a');
                    
                    // 创建一个临时图片对象来加载图片
                    const tempImage = new Image();
                    tempImage.crossOrigin = 'Anonymous'; // 处理跨域图片
                    tempImage.onload = function() {
                        // 图片加载完成后，创建一个canvas来绘制它
                        const canvas = document.createElement('canvas');
                        canvas.width = tempImage.width;
                        canvas.height = tempImage.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(tempImage, 0, 0);
                        
                        // 将canvas内容转换为data URL，然后设置为下载链接
                        link.href = canvas.toDataURL('image/png');
                        link.download = `generated-image-${Date.now()}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    };
                    tempImage.src = imageUrl;
                }
            });

            elements.saveHistoryBtn.addEventListener('click', () => {
                if (appState.generatedImages.length > 0) {
                    saveGeneratedImagesToHistory();
                    showToast('已保存到历史记录');
                }
            });

            elements.regenerateBtn.addEventListener('click', generateImage);

            elements.apiSettingBtn.addEventListener('click', () => {
                elements.apiModal.classList.remove('hidden');
                renderApiKeyList();
            });

            elements.closeApiModal.addEventListener('click', () => {
                elements.apiModal.classList.add('hidden');
            });

            elements.apiModal.addEventListener('click', (e) => {
                if (e.target === elements.apiModal) elements.apiModal.classList.add('hidden');
            });

            elements.addApiKeyBtn.addEventListener('click', addNewApiKey);

            elements.saveApiSetting.addEventListener('click', saveApiSettings);

            elements.clearHistoryBtn.addEventListener('click', () => {
                if (confirm('确定要清空所有历史记录吗？')) {
                    appState.historyImages = [];
                    appState.historyPage = 1;
                    saveHistory();
                    renderHistory();
                }
            });

            // --- 新增：案例图片放大预览 ---
            document.querySelectorAll('.case-item').forEach(item => {
                item.addEventListener('click', function() {
                    const imgSrc = this.getAttribute('data-img');
                    elements.previewModalImg.src = imgSrc;
                    elements.imagePreviewModal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // 防止背景滚动
                });
            });

            elements.closePreviewModal.addEventListener('click', () => {
                elements.imagePreviewModal.classList.add('hidden');
                document.body.style.overflow = ''; // 恢复背景滚动
            });

            elements.imagePreviewModal.addEventListener('click', (e) => {
                if (e.target === elements.imagePreviewModal) {
                    elements.imagePreviewModal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });
        }

        function renderApiKeyList() {
            elements.apiKeyList.innerHTML = '';
            appState.apiKeys.forEach((apiKey, index) => {
                const apiKeyItem = document.createElement('div');
                apiKeyItem.className = `flex items-center gap-2 mb-2 p-2 border ${index === appState.selectedApiKeyIndex ? 'border-primary bg-primary/5' : 'border-gray-200'} rounded-lg`;
                apiKeyItem.innerHTML = `
                    <input type="password" class="flex-1 border-none outline-none" placeholder="sk-..." value="${apiKey.key}">
                    <span class="text-xs bg-gray-200 px-2 py-1 rounded">积分: ${apiKey.credits || '--'}</span>
                    <button class="text-danger hover:text-red-600 delete-api-key" data-index="${index}">
                        <i class="fa fa-trash"></i>
                    </button>
                `;
                elements.apiKeyList.appendChild(apiKeyItem);
            });

            document.querySelectorAll('.delete-api-key').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    deleteApiKey(index);
                });
            });
        }

        function addNewApiKey() {
            appState.apiKeys.push({ key: '', credits: 0 });
            renderApiKeyList();
        }

        function deleteApiKey(index) {
            if (appState.apiKeys.length <= 1) {
                showToast('至少需要保留一个API Key', 'warning');
                return;
            }
            appState.apiKeys.splice(index, 1);
            if (appState.selectedApiKeyIndex === index) {
                appState.selectedApiKeyIndex = 0;
            } else if (appState.selectedApiKeyIndex > index) {
                appState.selectedApiKeyIndex--;
            }
            renderApiKeyList();
        }

        function saveApiSettings() {
            const apiKeyInputs = elements.apiKeyList.querySelectorAll('input[type="password"]');
            appState.apiKeys = Array.from(apiKeyInputs).map(input => ({
                key: input.value.trim(),
                credits: 0
            })).filter(apiKey => apiKey.key);
            
            if (appState.apiKeys.length === 0) {
                appState.apiKeys.push({ key: '', credits: 0 });
            }
            
            if (appState.selectedApiKeyIndex >= appState.apiKeys.length) {
                appState.selectedApiKeyIndex = 0;
            }
            
            localStorage.setItem('apiKeys', JSON.stringify(appState.apiKeys));
            elements.apiModal.classList.add('hidden');
            showToast('API Key 已保存');
            fetchAllApiCredits();
        }

        async function fetchAllApiCredits() {
            for (let i = 0; i < appState.apiKeys.length; i++) {
                const apiKey = appState.apiKeys[i];
                if (apiKey.key) {
                    try {
                        const response = await fetch(`https://grsai.dakka.com.cn/client/common/getCredits?apikey=${apiKey.key}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.code === 0 && data.data) {
                                appState.apiKeys[i].credits = data.data.credits || 0;
                            }
                        }
                    } catch (error) {
                        console.error(`获取API Key ${i+1} 积分失败:`, error);
                    }
                }
            }
            filterLowCreditKeys();
            updateCreditDisplay();
            renderApiKeyList();
            localStorage.setItem('apiKeys', JSON.stringify(appState.apiKeys));
        }

        function filterLowCreditKeys() {
            const initialLength = appState.apiKeys.length;
            appState.apiKeys = appState.apiKeys.filter(apiKey => apiKey.credits >= 400 || !apiKey.key);
            
            if (appState.apiKeys.length < initialLength) {
                showToast('积分低于400的API Key已自动删除', 'info');
                if (appState.selectedApiKeyIndex >= appState.apiKeys.length) {
                    appState.selectedApiKeyIndex = 0;
                }
            }
        }

        function updateCreditDisplay() {
            const currentKey = appState.apiKeys[appState.selectedApiKeyIndex];
            elements.creditCount.textContent = currentKey.credits || '--';
        }

        function updateModelSelection(modelName) {
            elements.gptConfig.classList.add('hidden');
            elements.bananaConfig.classList.add('hidden');
            elements.fluxConfig.classList.add('hidden');

            if (modelName === 'gpt') {
                elements.gptConfig.classList.remove('hidden');
            } else if (modelName === 'banana') {
                elements.bananaConfig.classList.remove('hidden');
            } else if (modelName === 'flux') {
                elements.fluxConfig.classList.remove('hidden');
            }
        }

        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => 
                file.type.startsWith('image/') && appState.uploadedImages.length < 5
            );
            if (validFiles.length === 0) {
                showToast('请上传图片文件，且最多上传5张', 'warning');
                return;
            }
            validFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    appState.uploadedImages.push(imageUrl);
                    const previewItem = document.createElement('div');
                    previewItem.className = 'relative rounded overflow-hidden';
                    previewItem.innerHTML = `
                        <img src="${imageUrl}" alt="预览图" class="w-full h-20 object-cover">
                        <button class="absolute top-1 right-1 bg-danger/80 text-white rounded-full w-5 h-5 flex items-center justify-center hover:bg-danger" data-url="${imageUrl}">
                            <i class="fa fa-times text-xs"></i>
                        </button>
                    `;
                    previewItem.querySelector('button').addEventListener('click', (e) => {
                        const urlToRemove = e.currentTarget.dataset.url;
                        appState.uploadedImages = appState.uploadedImages.filter(url => url !== urlToRemove);
                        e.currentTarget.closest('div').remove();
                        if (appState.uploadedImages.length === 0) elements.previewContainer.classList.add('hidden');
                    });
                    elements.previewList.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
            elements.previewContainer.classList.remove('hidden');
        }

        function toggleTag(tag) {
            appState.selectedTags.has(tag) ? appState.selectedTags.delete(tag) : appState.selectedTags.add(tag);
            renderSelectedTags();
        }

        function renderSelectedTags() {
            elements.selectedTags.innerHTML = '';
            if (appState.selectedTags.size > 0) {
                elements.selectedTagsContainer.classList.remove('hidden');
                appState.selectedTags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'bg-primary/10 text-primary px-3 py-1 rounded-full text-sm flex items-center gap-1';
                    tagElement.innerHTML = `
                        ${tag}
                        <button class="ml-1 text-primary/70 hover:text-primary" data-tag="${tag}">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    `;
                    tagElement.querySelector('button').addEventListener('click', (e) => toggleTag(e.currentTarget.dataset.tag));
                    elements.selectedTags.appendChild(tagElement);
                });
            } else {
                elements.selectedTagsContainer.classList.add('hidden');
            }
        }

        function getFullPrompt() {
            const tagText = Array.from(appState.selectedTags).join(', ');
            const customText = elements.customPrompt.value.trim();
            return tagText ? `${customText ? `${customText}，` : ''}${tagText}` : customText;
        }

        const IMGBB_API_KEY = 'e8bf0d415745ca4f4ceee30dd5745e16';
        function uploadImageToServer(dataUrl) {
            const [header, base64Data] = dataUrl.split(',');
            const formData = new FormData();
            formData.append('image', base64Data);
            return fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error(`上传失败，HTTP状态码: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success && data.data && data.data.url) return data.data.url;
                else throw new Error('ImgBB API 返回格式不正确: ' + JSON.stringify(data));
            })
            .catch(error => {
                console.error('图片上传到 ImgBB 时出错:', error);
                throw error;
            });
        }

        function saveGeneratedImagesToHistory() {
            const currentPrompt = getFullPrompt();
            let modelName = appState.selectedModel;
            if (modelName === 'banana') {
                modelName += ` (${appState.selectedBananaSubModel})`;
            } else if (modelName === 'flux') {
                modelName += ` (${elements.fluxSubModel.value})`;
            } else if (modelName === 'gpt') {
                 modelName += ` (sora-image)`;
            }

            appState.generatedImages.forEach(img => {
                appState.historyImages.unshift({
                    url: img.url,
                    prompt: currentPrompt,
                    model: modelName,
                    timestamp: new Date().toISOString()
                });
            });
            saveHistory();
            appState.historyPage = 1;
            renderHistory();
        }
        
        async function pollForResult(taskId, apiKey, timeout = 120000, interval = 3000) {
            const startTime = Date.now();
            while (Date.now() - startTime < timeout) {
                await new Promise(resolve => setTimeout(resolve, interval));
                try {
                    const response = await fetch('https://grsai.dakka.com.cn/v1/draw/result', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({ id: taskId })
                    });
                    if (!response.ok) {
                        throw new Error(`轮询结果失败: HTTP ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.code === 0 && result.data) {
                        const taskData = result.data;
                        if (taskData.status === 'succeeded') {
                            return taskData;
                        } else if (taskData.status === 'failed') {
                            throw new Error(`任务失败: ${taskData.failure_reason || taskData.error || '未知错误'}`);
                        }
                        updateProgressUI(taskData.progress || Math.min(95, Math.round(((Date.now() - startTime) / timeout) * 100)));
                    } else {
                        throw new Error(`轮询API返回异常: ${result.msg || '无错误信息'}`);
                    }
                } catch (error) {
                    console.error('轮询过程中发生错误:', error);
                }
            }
            throw new Error(`任务超时，请在稍后使用任务ID ${taskId} 手动查询结果。`);
        }
        
        function updateProgressUI(progress) {
            elements.previewResult.innerHTML = `
                <div class="animate-pulse flex flex-col items-center justify-center">
                    <div class="w-16 h-16 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-4"></div>
                    <p class="text-secondary mb-2">生成中...</p>
                    <p class="text-xs text-gray-500">进度: ${progress}%</p>
                </div>
            `;
        }

        async function generateImage() {
            if (appState.apiKeys.length === 0 || !appState.apiKeys[0].key) {
                showToast('请先设置API Key', 'warning');
                elements.apiModal.classList.remove('hidden');
                return;
            }

            const prompt = getFullPrompt();
            if (!prompt && appState.uploadedImages.length === 0) {
                showToast('请至少提供提示词或参考图片', 'warning');
                return;
            }

            let currentApiKeyIndex = appState.selectedApiKeyIndex;
            let apiKey = appState.apiKeys[currentApiKeyIndex].key;
            let cost = getModelCost(appState.selectedModel);
            
            if (appState.apiKeys[currentApiKeyIndex].credits < cost) {
                currentApiKeyIndex = findNextAvailableApiKey(currentApiKeyIndex);
                if (currentApiKeyIndex === -1) {
                    showToast('所有API Key积分不足，请充值后再试', 'warning');
                    return;
                }
                appState.selectedApiKeyIndex = currentApiKeyIndex;
                apiKey = appState.apiKeys[currentApiKeyIndex].key;
                showToast(`当前API Key积分不足，已自动切换到第${currentApiKeyIndex + 1}个Key`, 'info');
            }

            elements.generateBtn.disabled = true;
            elements.generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 生成中...';
            elements.generationStatus.classList.remove('hidden');
            elements.resultActions.classList.add('hidden');
            updateProgressUI(0);

            try {
                const isGPTModel = appState.selectedModel === 'gpt';
                const isFluxModel = appState.selectedModel === 'flux';

                const requestData = {
                    prompt: prompt,
                    shutProgress: false,
                };

                if (appState.uploadedImages.length > 0) {
                    requestData.urls = await Promise.all(appState.uploadedImages.map(img => uploadImageToServer(img)));
                }
                
                let apiUrl;
                if (isGPTModel) {
                    apiUrl = 'https://grsai.dakka.com.cn/v1/draw/completions';
                    requestData.model = 'sora-image';
                    requestData.size = elements.forceResolution.checked ? 'auto' : elements.imageSize.value;
                    requestData.variants = 1;
                    requestData.webHook = "-1";
                } else if (isFluxModel) {
                    apiUrl = 'https://grsai.dakka.com.cn/v1/draw/flux';
                    requestData.model = elements.fluxSubModel.value;
                    requestData.aspectRatio = elements.forceResolution.checked ? 'auto' : elements.imageSize.value;
                } else {
                    apiUrl = 'https://grsai.dakka.com.cn/v1/draw/nano-banana';
                    requestData.model = appState.selectedBananaSubModel;
                    requestData.aspectRatio = elements.forceResolution.checked ? 'auto' : elements.imageSize.value;
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestData)
                });

                let resultData = null;

                if (isGPTModel) {
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('GPT API 请求失败:', errorText);
                        throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                    }
                    const initialResponse = await response.json();
                    if (initialResponse.code === 0 && initialResponse.data && initialResponse.data.id) {
                        const taskId = initialResponse.data.id;
                        showToast(`任务已提交，ID: ${taskId}，开始轮询结果...`, 'info');
                        resultData = await pollForResult(taskId, apiKey);
                    } else {
                        throw new Error(`GPT API 未能返回任务ID: ${initialResponse.msg || '未知错误'}`);
                    }
                } else {
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('流式API请求失败:', errorText);
                        throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                    }
                    if (!response.body) {
                        throw new Error('服务器不支持流式响应');
                    }
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullResponseText = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        fullResponseText += chunk;
                        
                        const lines = chunk.split('\n').filter(line => line.trim());
                        for (const line of lines) {
                            try {
                                let data;
                                if (line.startsWith('data: ')) {
                                    data = JSON.parse(line.slice(6));
                                } else {
                                    data = JSON.parse(line);
                                }
                                
                                if (data.code === -1 && data.msg) {
                                    throw new Error(`API错误: ${data.msg}`);
                                }
                                
                                if (data.progress !== undefined) {
                                    updateProgressUI(data.progress);
                                }
                                if (data.status === 'succeeded') {
                                    resultData = data;
                                    break;
                                } else if (data.status === 'failed') {
                                    throw new Error(`生成失败: ${data.failure_reason || data.error || '未知错误'}`);
                                }
                            } catch (e) {
                                console.warn('解析流式数据失败，跳过:', line, e);
                            }
                        }
                        if (resultData) break;
                    }
                    if (!resultData) {
                        console.warn('流式响应未找到明确的成功信号，尝试解析完整响应:', fullResponseText);
                        try {
                            const fullData = JSON.parse(fullResponseText);
                            if (fullData.code === -1 && fullData.msg) {
                                throw new Error(`API错误: ${fullData.msg}`);
                            }
                            if (fullData.url || (fullData.results && fullData.results.length > 0)) {
                                resultData = fullData;
                            } else {
                               throw new Error('流式响应未包含有效结果');
                            }
                        } catch (e) {
                            throw new Error('流式响应解析失败或不完整。' + (e.message ? ' ' + e.message : ''));
                        }
                    }
                }
                
                handleSuccessfulResult(resultData, currentApiKeyIndex);

            } catch (error) {
                console.error('生成图片时出错:', error);
                elements.previewResult.innerHTML = `
                    <i class="fa fa-exclamation-triangle text-warning text-5xl mb-3"></i>
                    <p class="text-danger mb-2">生成失败</p>
                    <p class="text-sm text-gray-500">${error.message}</p>
                `;
            } finally {
                elements.generateBtn.disabled = false;
                elements.generateBtn.innerHTML = '<i class="fa fa-magic"></i><span>开始生成</span>';
                elements.generationStatus.classList.add('hidden');
            }
        }
        
        function handleSuccessfulResult(resultData, apiKeyIndex) {
            if (resultData.results && resultData.results.length > 0) {
                appState.generatedImages = resultData.results;
            } else if (resultData.url) {
                appState.generatedImages = [{ url: resultData.url }];
            } else {
                throw new Error('生成成功，但未返回有效图片URL。');
            }

            const imageUrl = appState.generatedImages[0].url;
            
            elements.previewResult.innerHTML = `
                <img src="${imageUrl}" alt="生成结果" class="max-w-full max-h-[400px] object-contain rounded-lg preview-shadow">
            `;
            elements.resultActions.classList.remove('hidden');
            
            deductCredit(apiKeyIndex, appState.selectedModel);
            saveGeneratedImagesToHistory();
            
            if (appState.generatedImages.length > 1) {
                showToast(`成功生成 ${appState.generatedImages.length} 张图片，已自动保存到历史记录。`, 'success');
            } else {
                showToast('图片生成成功，已自动保存到历史记录！', 'success');
            }
        }

        function getModelCost(model) {
            switch(model) {
                case 'gpt':
                    return 20;
                case 'flux':
                    return 15;
                case 'banana':
                    return 10;
                default:
                    return 10;
            }
        }

        function deductCredit(apiKeyIndex, model) {
            const cost = getModelCost(model);
            appState.apiKeys[apiKeyIndex].credits = Math.max(0, appState.apiKeys[apiKeyIndex].credits - cost);
            updateCreditDisplay();
            localStorage.setItem('apiKeys', JSON.stringify(appState.apiKeys));
        }

        function findNextAvailableApiKey(currentIndex) {
            const cost = getModelCost(appState.selectedModel);
            for (let i = 0; i < appState.apiKeys.length; i++) {
                const index = (currentIndex + 1 + i) % appState.apiKeys.length;
                if (index !== currentIndex && appState.apiKeys[index].credits >= cost) {
                    return index;
                }
            }
            return -1;
        }

        function saveHistory() {
            localStorage.setItem('imageHistory', JSON.stringify(appState.historyImages));
        }

        function renderHistory() {
            const startIndex = (appState.historyPage - 1) * appState.historyPageSize;
            const endIndex = startIndex + appState.historyPageSize;
            const paginatedHistory = appState.historyImages.slice(startIndex, endIndex);
            
            if (appState.historyImages.length === 0) {
                elements.historyContainer.innerHTML = `
                    <div class="col-span-full text-center py-8 text-secondary">
                        <i class="fa fa-folder-open-o text-4xl mb-3"></i>
                        <p>暂无历史生成记录</p>
                    </div>
                `;
                return;
            }
            
            elements.historyContainer.innerHTML = '';
            paginatedHistory.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'relative rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow';
                historyItem.innerHTML = `
                    <img src="${item.url}" alt="历史记录 ${index + 1}" class="w-full h-24 object-cover">
                    <div class="absolute inset-0 bg-black/50 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                        <button class="view-history bg-white/90 text-dark p-1 rounded-full hover:bg-white" data-item='${JSON.stringify(item)}'>
                            <i class="fa fa-eye"></i>
                        </button>
                        <button class="delete-history bg-white/90 text-danger p-1 rounded-full hover:bg-white" data-original-index="${startIndex + index}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                historyItem.querySelector('.view-history').addEventListener('click', (e) => {
                    const item = JSON.parse(e.currentTarget.dataset.item);
                    elements.previewResult.innerHTML = `
                        <img src="${item.url}" alt="历史记录" class="max-w-full max-h-[400px] object-contain rounded-lg preview-shadow">
                    `;
                    appState.generatedImages = [{ url: item.url }];
                    elements.resultActions.classList.remove('hidden');
                });
                historyItem.querySelector('.delete-history').addEventListener('click', (e) => {
                    const originalIndex = parseInt(e.currentTarget.dataset.originalIndex);
                    appState.historyImages.splice(originalIndex, 1);
                    
                    if (paginatedHistory.length === 1 && appState.historyPage > 1) {
                        appState.historyPage--;
                    }
                    
                    saveHistory();
                    renderHistory();
                });
                elements.historyContainer.appendChild(historyItem);
            });
            
            if (appState.historyImages.length > appState.historyPageSize) {
                const pagination = document.createElement('div');
                pagination.className = 'col-span-full flex justify-center mt-4 gap-2';
                
                if (appState.historyPage > 1) {
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'px-3 py-1 rounded border border-gray-300 hover:bg-gray-100';
                    prevBtn.innerHTML = '<i class="fa fa-chevron-left"></i>';
                    prevBtn.addEventListener('click', () => {
                        appState.historyPage--;
                        renderHistory();
                    });
                    pagination.appendChild(prevBtn);
                }
                
                const pageInfo = document.createElement('span');
                pageInfo.className = 'px-3 py-1 text-sm';
                pageInfo.textContent = `${appState.historyPage} / ${Math.ceil(appState.historyImages.length / appState.historyPageSize)}`;
                pagination.appendChild(pageInfo);
                
                if (endIndex < appState.historyImages.length) {
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'px-3 py-1 rounded border border-gray-300 hover:bg-gray-100';
                    nextBtn.innerHTML = '<i class="fa fa-chevron-right"></i>';
                    nextBtn.addEventListener('click', () => {
                        appState.historyPage++;
                        renderHistory();
                    });
                    pagination.appendChild(nextBtn);
                }
                
                elements.historyContainer.appendChild(pagination);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
            switch(type) {
                case 'success':
                    toast.classList.add('bg-success', 'text-white');
                    toast.innerHTML = `<i class="fa fa-check-circle mr-2"></i>${message}`;
                    break;
                case 'warning':
                    toast.classList.add('bg-warning', 'text-white');
                    toast.innerHTML = `<i class="fa fa-exclamation-triangle mr-2"></i>${message}`;
                    break;
                case 'error':
                    toast.classList.add('bg-danger', 'text-white');
                    toast.innerHTML = `<i class="fa fa-times-circle mr-2"></i>${message}`;
                    break;
                default:
                    toast.classList.add('bg-primary', 'text-white');
                    toast.innerHTML = `<i class="fa fa-info-circle mr-2"></i>${message}`;
            }
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
                toast.classList.add('translate-x-0');
            }, 100);
            setTimeout(() => {
                toast.classList.remove('translate-x-0');
                toast.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>