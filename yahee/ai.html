<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>万物皆可AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6',
                        secondary: '#64748B',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        light: '#F8FAFC',
                        dark: '#1E293B'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .preview-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
            .btn-hover { @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5; }
            .tag-hover { @apply transition-all duration-200 hover:bg-primary/10 hover:text-primary cursor-pointer; }
            .model-card { @apply border border-gray-200 rounded-xl p-3 cursor-pointer transition-all duration-300 hover:border-primary hover:bg-primary/5 hover:shadow-md; }
            .model-card.active { @apply border-primary bg-primary/5 ring-2 ring-primary/20 shadow-md; }
            .model-card.disabled { @apply opacity-60 cursor-not-allowed; }
            .card-shadow { @apply shadow-md hover:shadow-lg transition-shadow duration-300; }
            .status-dot { @apply w-2 h-2 rounded-full inline-block mr-1; }
            .zoomable-image { @apply cursor-zoom-in transition-transform duration-200 hover:scale-105; }
        }
    </style>
</head>
<body class="font-inter bg-light text-dark min-h-screen flex flex-col">
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa fa-paint-brush text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">万物皆可AI ~~~ YaHee, Studio. ~~~</h1>
            </div>
            <div class="flex items-center gap-4">
                <div id="creditDisplay" class="flex items-center gap-1 text-sm text-secondary">
                    <i class="fa fa-credit-card text-primary"></i>
                    <span>当前积分: <span id="creditCount">--</span></span>
                    <span id="totalCredit" class="ml-2 hidden">(总积分: <span id="totalCreditCount">--</span>)</span>
                    <div id="creditStatus" class="ml-2 hidden"></div>
                </div>
                <button id="apiSettingBtn" class="flex items-center gap-1 text-secondary hover:text-primary btn-hover px-3 py-1.5 rounded-lg">
                    <i class="fa fa-key"></i>
                    <span class="hidden sm:inline">API 设置</span>
                </button>
                <a href="https://ganxiang.xiaoyina.com/quotation/productView" target="_blank" class="flex items-center gap-1 text-secondary hover:text-primary btn-hover px-3 py-1.5 rounded-lg">
                    <i class="fa fa-print"></i>
                    <span class="hidden sm:inline">印刷报价</span>
                </a>
                <a href="https://yaheex.github.io/yahee/baojia.html" target="_blank" class="flex items-center gap-1 text-secondary hover:text-primary btn-hover px-3 py-1.5 rounded-lg">
                    <i class="fa fa-bullhorn"></i>
                    <span class="hidden sm:inline">广告报价</span>
                </a>					
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <!-- 生成配置 - 移到最上面 -->
                <div class="bg-white rounded-xl p-5 shadow-sm card-shadow">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fa fa-sliders text-primary"></i>
                        生成配置
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">选择模型：Banana搞不定的图就选GPT。</label>
                            <div class="grid grid-cols-1 gap-2" id="modelSelector">
                                <div class="model-card" data-model="gpt">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-medium flex items-center">
                                                GPT
                                                <span class="status-dot bg-success ml-2"></span>
                                                <span class="text-xs text-gray-500 ml-1">正常</span>
                                            </h4>
                                            <p class="text-xs text-gray-500 mt-1">超强还原、超强理解能力。1-2分钟出图。400积分/次  ￥0.02~￥0.04/次</p>
                                        </div>
                                        <i class="fa fa-check-circle text-primary hidden"></i>
                                    </div>
                                </div>
                                <div class="model-card active" data-model="banana">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-medium flex items-center">
                                                Banana
                                                <span class="status-dot bg-success ml-2"></span>
                                                <span class="text-xs text-gray-500 ml-1">正常</span>
                                            </h4>
                                            <p class="text-xs text-gray-500 mt-1">超强一致性。30秒左右出图。</p>
                                        </div>
                                        <i class="fa fa-check-circle text-primary"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="gptConfig" class="border-l-4 border-primary pl-4 py-2 hidden">
                            <p class="text-sm text-gray-500">默认生成 1 张图片。</p>
                        </div>

                        <div id="bananaConfig" class="border-l-4 border-primary pl-4 py-2">
                            <div>
                                <label for="bananaSubModel" class="block text-sm font-medium text-gray-600 mb-2">Banana 子模型：</label>
                                <select id="bananaSubModel" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary">
                                    <option value="nano-banana-pro">banana-pro ~~~ 1800积分/次 - ￥0.09~￥0.18/次</option>
                                    <option value="nano-banana">banana ~~~ 1400积分/次 - ￥0.07~￥0.14/次</option>
                                </select>
                            </div>
                            <!-- 新增图像大小选择，仅对pro模型显示 -->
                            <div id="bananaImageSizeContainer" class="mt-2 hidden">
                                <label for="bananaImageSize" class="block text-sm font-medium text-gray-600 mb-2">图像大小 (仅Pro模型)：</label>
                                <select id="bananaImageSize" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary">
                                    <option value="1K" selected>1K</option>
                                    <option value="2K">2K</option>
                                    <option value="4K">4K</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="imageSize" class="block text-sm font-medium text-gray-600 mb-2">图片比例：</label>
                            <select id="imageSize" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary">
                                <option value="auto">自动</option>
                                <option value="1:1">1:1（正方形）</option>
                                <option value="3:2">3:2（横屏）</option>
                                <option value="2:3">2:3（竖屏）</option>
                                <option value="16:9">16:9（宽屏）</option>
                                <option value="9:16">9:16（竖屏视频）</option>
                                <option value="4:3">4:3（传统电视）</option>
                                <option value="3:4">3:4（竖屏照片）</option>
                                <option value="5:4">5:4（打印照片）</option>
                                <option value="21:9">21:9（电影宽屏）</option>
                            </select>
                        </div>

                        <button id="generateBtn" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg btn-hover flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fa fa-magic"></i>
                            <span>开始生成</span>
                        </button>
                    </div>
                </div>

                <!-- 上传参考图片 -->
                <div class="bg-white rounded-xl p-5 shadow-sm card-shadow">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fa fa-upload text-primary"></i>
                        上传参考图片
                    </h2>
                    <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer bg-gray-50">
                        <input type="file" id="imageUpload" accept="image/*" multiple class="hidden">
                        <i class="fa fa-picture-o text-4xl text-gray-400 mb-3"></i>
                        <p class="text-secondary mb-2">点击或拖拽图片至此处上传</p>
                        <p class="text-xs text-gray-500">支持JPG、PNG格式，最多上传5张</p>
                    </div>
                    <div id="previewContainer" class="mt-4 grid grid-cols-3 gap-2 hidden">
                        <h3 class="col-span-3 text-sm font-medium text-gray-600 mb-2">预览图：</h3>
                        <div id="previewList" class="col-span-3 grid grid-cols-3 gap-2"></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <!-- 描述词配置 - 移到右侧顶部 -->
                <div class="bg-white rounded-xl p-5 shadow-sm card-shadow">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fa fa-comment text-primary"></i>
                        描述词配置
                    </h2>
                    <div class="mb-4">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">预设描述词：</h3>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto pr-1" id="presetTags">
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="提取图案">提取图案</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="提取菜品">提取菜品</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="增强细节">增强细节</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="完善细节">完善细节</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="增强画质">增强画质</span>
							<span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="摄影画质">摄影画质</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="只保留主体">保留主体</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="重绘">重绘</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="只保留人物">保留人物</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="移除所有破损划痕和噪点，纠正角度生成人像照，增强画质，照片修复，还原人物所有细节，转高清图，摄影画质，补全完整人物，上色">修复人像</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="人物变清晰">人物变清晰</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="透视矫正，矫正为正视图">透视矫正</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="保持一致性">保持一致性</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="填充红色的区域,使其融合自然">按比例扩图</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="白底黑内容">白底黑内容</span>
							<span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="矫正图形，改为正视图">矫正图形</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="转为平面图">转为平面图</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="转为线稿图">转为线稿图</span>
							<span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="给文字内容搭配一个背景，去掉所有文字，只要背景">生成背景图</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="转为矢量图风格，去掉所有阴影效果">转为矢量图风格</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="去掉所有文字">去所有文字</span>
							<span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="消除布纹，优化布纹处细节，移除噪点，色块平滑">去布纹</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="移除背景，改为白色背景">白色背景</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="透明背景">透明背景(GPT)</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="将图像中的所有设计元素完全分离，转换为独立的平面设计素材。每个元素必须：1) 完全独立无连接；2) 元素间保持至少20像素的最小间距；3) 采用严格的网格化布局排列；4) 所有元素正面朝向，无角度倾斜；5) 按元素类型和大小智能分组排列；6) 浅灰色(#f5f5f5)极简背景，无任何装饰元素；7) 元素排列遵循从左到右、从上到下的阅读顺序；8) 如元素过多则自动创建多行多列布局，确保所有元素完整可见；9) 生成前进行重叠检测，如有重叠风险则自动调整元素位置和大小。">拆分元素(banana-pro)</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="修复并为这张照片上色">照片上色</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="改为夜间亮化效果图">改为夜间亮化效果图</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="发光字">发光字</span>
                            <span class="tag-hover px-3 py-1 rounded-full text-sm border border-gray-200" data-tag="发光灯带">发光灯带</span>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="customPrompt" class="block text-sm font-medium text-gray-600 mb-2">自定义描述词：</label>
                        <textarea id="customPrompt" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary" placeholder="请输入图片描述，越详细生成效果越好..."></textarea>
                    </div>
                    <div id="selectedTagsContainer" class="mb-2 hidden">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">已选描述词：</h3>
                        <div id="selectedTags" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 生成预览 - 缩小高度并占2/3宽度 -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl p-5 shadow-sm card-shadow">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold flex items-center gap-2">
                                    <i class="fa fa-eye text-primary"></i>
                                    生成预览
                                </h2>
                                <div id="generationStatus" class="text-sm text-secondary hidden">
                                    <i class="fa fa-spinner fa-spin mr-1"></i>
                                    <span>生成中...</span>
                                </div>
                            </div>
                            <div id="previewResult" class="border border-gray-200 rounded-lg p-6 text-center bg-gray-50 min-h-[300px] flex flex-col items-center justify-center">
                                <i class="fa fa-image text-4xl text-gray-300 mb-3"></i>
                                <p class="text-secondary mb-1">生成的图片将显示在这里</p>
                                <p class="text-xs text-gray-500">生成的图片链接有效期为2小时</p>
                            </div>
                            <div id="resultActions" class="mt-4 flex justify-center gap-3 hidden">
                                <button id="downloadBtn" class="bg-success text-white px-4 py-2 rounded-lg btn-hover flex items-center gap-1">
                                    <i class="fa fa-download"></i>
                                    <span>下载图片</span>
                                </button>
                                <button id="saveHistoryBtn" class="bg-primary text-white px-4 py-2 rounded-lg btn-hover flex items-center gap-1">
                                    <i class="fa fa-save"></i>
                                    <span>保存到历史</span>
                                </button>
                                <button id="regenerateBtn" class="bg-secondary text-white px-4 py-2 rounded-lg btn-hover flex items-center gap-1">
                                    <i class="fa fa-refresh"></i>
                                    <span>重新生成</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 历史生成记录 - 移到右侧并缩小，占1/3宽度 -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl p-5 shadow-sm card-shadow h-full">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold flex items-center gap-2">
                                    <i class="fa fa-history text-primary"></i>
                                    历史记录
                                </h2>
                                <button id="clearHistoryBtn" class="text-sm text-danger hover:underline">清空</button>
                            </div>
                            <div id="historyContainer" class="grid grid-cols-2 gap-2 max-h-[300px] overflow-y-auto">
                                <div class="col-span-full text-center py-8 text-secondary">
                                    <i class="fa fa-folder-open-o text-3xl mb-3"></i>
                                    <p class="text-sm">暂无历史记录</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 案例展示 -->
                <div class="bg-white rounded-xl p-5 shadow-sm card-shadow">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fa fa-th-large text-primary"></i>
                        案例展示
                    </h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3" id="casesContainer">
                        <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170801z6GbUq.jpg" title="案例1">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170801z6GbUq.jpg" alt="案例1" class="w-full h-24 object-cover zoomable-image">
                        </div>
                        <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170808ubntSM.jpg" title="案例2">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170808ubntSM.jpg" alt="案例2" class="w-full h-24 object-cover zoomable-image">
                        </div>
                        <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/17636171708098d5xv1.jpg" title="案例3">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/17636171708098d5xv1.jpg" alt="案例3" class="w-full h-24 object-cover zoomable-image">
                        </div>
                        <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170810zjAXwx.jpg" title="案例4">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170810zjAXwx.jpg" alt="案例4" class="w-full h-24 object-cover zoomable-image">
                        </div>
                        <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170812GWectp.jpg" title="案例5">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763617170812GWectp.jpg" alt="案例5" class="w-full h-24 object-cover zoomable-image">
                        </div> 
                        <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/176394894500339KVZA.jpg" title="案例6">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/176394894500339KVZA.jpg" alt="案例6" class="w-full h-24 object-cover zoomable-image">
                        </div>
                        <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763948945007deifl_.jpg" title="案例7">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763948945007deifl_.jpg" alt="案例7" class="w-full h-24 object-cover zoomable-image">
                        </div>
                        <div class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow cursor-pointer case-item" data-img="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763718210978aP6ZD2.jpg" title="案例8">
                            <img src="https://aisearch.cdn.bcebos.com/fileManager/n-JQzIHmOAQdZItDkjSd3Q/1763718210978aP6ZD2.jpg" alt="案例8" class="w-full h-24 object-cover zoomable-image">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 py-4 mt-6">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500">
            <p>YaHee, Studio.</p>
        </div>
    </footer>

    <!-- API 设置模态框 -->
    <div id="apiModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">API 设置</h3>
                <button id="closeApiModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- 积分统计区域 -->
            <div class="mb-4 p-3 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">积分统计</span>
                    <button id="refreshCredits" class="text-xs bg-primary/10 text-primary px-2 py-1 rounded hover:bg-primary/20 transition-colors">
                        <i class="fa fa-refresh mr-1"></i>刷新
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div class="text-center p-2 bg-white rounded border">
                        <div class="text-gray-500">有效API</div>
                        <div id="validApiCount" class="font-bold text-primary">0</div>
                    </div>
                    <div class="text-center p-2 bg-white rounded border">
                        <div class="text-gray-500">总积分</div>
                        <div id="modalTotalCredit" class="font-bold text-success">0</div>
                    </div>
                    <div class="text-center p-2 bg-white rounded border">
                        <div class="text-gray-500">最高积分</div>
                        <div id="maxCredit" class="font-bold text-warning">0</div>
                    </div>
                    <div class="text-center p-2 bg-white rounded border">
                        <div class="text-gray-500">最低积分</div>
                        <div id="minCredit" class="font-bold text-danger">0</div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                <!-- 批量操作区域 -->
                <div class="border-b border-gray-200 pb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">批量操作</label>
                    <div class="flex gap-2">
                        <button id="batchAddBtn" class="flex-1 bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg btn-hover">
                            <i class="fa fa-plus mr-2"></i>批量添加
                        </button>
                        <button id="batchExportBtn" class="flex-1 bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg btn-hover">
                            <i class="fa fa-download mr-2"></i>批量导出
                        </button>
                    </div>
                </div>
                
                <!-- 批量添加 API Key 区域 -->
                <div class="border-b border-gray-200 pb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">批量添加 API Key（每行一个）</label>
                    <textarea id="batchApiKeys" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary resize-none" placeholder="请输入多个 API Key，每行一个"></textarea>
                </div>
                
                <div id="apiKeyList" class="max-h-60 overflow-y-auto">
                    <div class="flex items-center gap-2 mb-2 p-2 border border-gray-200 rounded-lg">
                        <input type="password" class="flex-1 border-none outline-none" placeholder="sk-..." value="">
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">积分: --</span>
                        <button class="text-danger hover:text-red-600">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
                <button id="addApiKeyBtn" class="w-full bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg btn-hover">
                    <i class="fa fa-plus mr-2"></i>添加API Key
                </button>
                <button id="saveApiSetting" class="w-full bg-primary text-white font-medium py-2.5 px-4 rounded-lg btn-hover">保存设置</button>
            </div>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div id="imagePreviewModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <button id="closePreviewModal" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300">
            <i class="fa fa-times"></i>
        </button>
        <img id="previewModalImg" src="" alt="放大预览" class="max-w-[90%] max-h-[90vh] object-contain">
    </div>

    <script>
        const BASE_URL = 'https://grsai.dakka.com.cn';
        
        const appState = {
            uploadedImages: [],
            selectedTags: new Set(),
            generatedImages: [],
            historyImages: JSON.parse(localStorage.getItem('imageHistory')) || [],
            apiKeys: JSON.parse(localStorage.getItem('apiKeys')) || [{ key: '', credits: 0 }],
            selectedApiKeyIndex: 0,
            selectedModel: 'banana',
            selectedBananaSubModel: 'nano-banana',
            historyPage: 1,
            historyPageSize: 8,
            maxCredit: 10000,
            modelStatus: {
                gpt: { status: true, error: '' },
                banana: { status: true, error: '' }
            },
            totalCredits: 0,
            validApiCount: 0,
            modelStatusCheckInterval: null
        };

        const elements = {
            uploadArea: document.getElementById('uploadArea'),
            imageUpload: document.getElementById('imageUpload'),
            previewContainer: document.getElementById('previewContainer'),
            previewList: document.getElementById('previewList'),
            presetTags: document.getElementById('presetTags'),
            customPrompt: document.getElementById('customPrompt'),
            selectedTagsContainer: document.getElementById('selectedTagsContainer'),
            selectedTags: document.getElementById('selectedTags'),
            modelSelector: document.getElementById('modelSelector'),
            gptConfig: document.getElementById('gptConfig'),
            bananaConfig: document.getElementById('bananaConfig'),
            bananaSubModel: document.getElementById('bananaSubModel'),
            bananaImageSizeContainer: document.getElementById('bananaImageSizeContainer'),
            bananaImageSize: document.getElementById('bananaImageSize'),
            imageSize: document.getElementById('imageSize'),
            generateBtn: document.getElementById('generateBtn'),
            previewResult: document.getElementById('previewResult'),
            resultActions: document.getElementById('resultActions'),
            downloadBtn: document.getElementById('downloadBtn'),
            saveHistoryBtn: document.getElementById('saveHistoryBtn'),
            regenerateBtn: document.getElementById('regenerateBtn'),
            historyContainer: document.getElementById('historyContainer'),
            apiSettingBtn: document.getElementById('apiSettingBtn'),
            apiModal: document.getElementById('apiModal'),
            closeApiModal: document.getElementById('closeApiModal'),
            apiKeyList: document.getElementById('apiKeyList'),
            addApiKeyBtn: document.getElementById('addApiKeyBtn'),
            saveApiSetting: document.getElementById('saveApiSetting'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            generationStatus: document.getElementById('generationStatus'),
            creditDisplay: document.getElementById('creditDisplay'),
            creditCount: document.getElementById('creditCount'),
            casesContainer: document.getElementById('casesContainer'),
            imagePreviewModal: document.getElementById('imagePreviewModal'),
            closePreviewModal: document.getElementById('closePreviewModal'),
            previewModalImg: document.getElementById('previewModalImg'),
            batchApiKeys: document.getElementById('batchApiKeys'),
            batchAddBtn: document.getElementById('batchAddBtn'),
            batchExportBtn: document.getElementById('batchExportBtn'),
            totalCredit: document.getElementById('totalCredit'),
            totalCreditCount: document.getElementById('totalCreditCount'),
            creditStatus: document.getElementById('creditStatus'),
            validApiCount: document.getElementById('validApiCount'),
            modalTotalCredit: document.getElementById('modalTotalCredit'),
            maxCredit: document.getElementById('maxCredit'),
            minCredit: document.getElementById('minCredit'),
            refreshCredits: document.getElementById('refreshCredits')
        };

        // 模型状态检查相关函数
        async function checkModelStatus(modelName) {
            try {
                const response = await fetch(`${BASE_URL}/client/common/getModelStatus?model=${modelName}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.code === 0) {
                        appState.modelStatus[modelName] = data.data;
                        updateModelStatusUI(modelName, data.data);
                        return data.data;
                    }
                }
                // 如果请求失败，设置默认状态为异常
                appState.modelStatus[modelName] = { status: false, error: '状态检查失败' };
                updateModelStatusUI(modelName, { status: false, error: '状态检查失败' });
            } catch (error) {
                console.error(`检查模型 ${modelName} 状态失败:`, error);
                appState.modelStatus[modelName] = { status: false, error: '网络错误' };
                updateModelStatusUI(modelName, { status: false, error: '网络错误' });
            }
        }

        async function checkAllModelStatus() {
            const models = ['sora-image', 'nano-banana-pro'];
            for (const model of models) {
                await checkModelStatus(model);
            }
        }

        function updateModelStatusUI(modelName, statusData) {
            const modelCard = document.querySelector(`.model-card[data-model="${modelName}"]`);
            if (!modelCard) return;
            
            const statusDot = modelCard.querySelector('.status-dot');
            const statusText = modelCard.querySelector('.text-xs.text-gray-500');
            
            if (statusData.status) {
                // 模型正常
                statusDot.className = 'status-dot bg-success';
                statusText.textContent = '正常';
                modelCard.classList.remove('disabled');
                
                // 如果当前选中的模型恢复正常，确保可以点击
                if (modelName === appState.selectedModel) {
                    modelCard.classList.add('active');
                    modelCard.querySelector('.fa-check-circle').classList.remove('hidden');
                }
            } else {
                // 模型异常
                statusDot.className = 'status-dot bg-danger';
                statusText.textContent = statusData.error || '异常';
                modelCard.classList.add('disabled');
                
                // 如果当前选中的模型异常，自动切换到其他可用模型
                if (modelName === appState.selectedModel) {
                    switchToAvailableModel();
                }
            }
        }

        function switchToAvailableModel() {
            const models = ['sora-image', 'nano-banana-pro'];
            const availableModel = models.find(model => 
                appState.modelStatus[model] && appState.modelStatus[model].status
            );
            
            if (availableModel && availableModel !== appState.selectedModel) {
                // 自动切换到可用的模型
                const modelCard = document.querySelector(`.model-card[data-model="${availableModel}"]`);
                if (modelCard && !modelCard.classList.contains('disabled')) {
                    modelCard.click(); // 触发点击事件来切换模型
                    showToast(`模型 ${appState.selectedModel} 异常，已自动切换到 ${availableModel}`, 'warning');
                }
            } else if (!availableModel) {
                // 所有模型都不可用
                showToast('所有模型当前都不可用，请稍后再试', 'error');
                elements.generateBtn.disabled = true;
            }
        }

        function startModelStatusPolling() {
            // 每2分钟检查一次模型状态
            appState.modelStatusCheckInterval = setInterval(() => {
                checkAllModelStatus();
            }, 1222 * 60 * 1000);
        }

        function stopModelStatusPolling() {
            if (appState.modelStatusCheckInterval) {
                clearInterval(appState.modelStatusCheckInterval);
                appState.modelStatusCheckInterval = null;
            }
        }

        function init() {
            renderApiKeyList();
            elements.bananaSubModel.value = appState.selectedBananaSubModel;
            renderHistory();
            bindEvents();
            updateModelSelection(appState.selectedModel);
            updateCreditDisplay();
            updateCreditStatistics();
            
            if (appState.apiKeys.length > 0 && appState.apiKeys[0].key) {
                fetchAllApiCredits();
            }
            
            // 添加模型状态检查
            checkAllModelStatus();
            startModelStatusPolling();
        }

        function bindEvents() {
            elements.uploadArea.addEventListener('click', () => elements.imageUpload.click());
            elements.uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.add('border-primary', 'bg-primary/5');
            });
            elements.uploadArea.addEventListener('dragleave', () => {
                elements.uploadArea.classList.remove('border-primary', 'bg-primary/5');
            });
            elements.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.remove('border-primary', 'bg-primary/5');
                if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
            });
            elements.imageUpload.addEventListener('change', (e) => {
                if (e.target.files.length) handleFiles(e.target.files);
            });

            elements.presetTags.addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN' && e.target.dataset.tag) toggleTag(e.target.dataset.tag);
            });

            const modelCards = document.querySelectorAll('.model-card');
            modelCards.forEach(card => {
                card.addEventListener('click', function() {
                    const modelName = this.dataset.model;
                    if (this.classList.contains('disabled')) {
                        const status = appState.modelStatus[modelName];
                        showToast(`模型 ${modelName} 当前不可用: ${status.error}`, 'warning');
                        return;
                    }
                    if (this.classList.contains('active')) return;
                    modelCards.forEach(c => {
                        c.classList.remove('active');
                        c.querySelector('.fa-check-circle').classList.add('hidden');
                    });
                    this.classList.add('active');
                    this.querySelector('.fa-check-circle').classList.remove('hidden');
                    appState.selectedModel = modelName;
                    updateModelSelection(modelName);
                });
            });
            
            elements.bananaSubModel.addEventListener('change', function() {
                appState.selectedBananaSubModel = this.value;
                updateBananaImageSizeVisibility();
            });

            elements.generateBtn.addEventListener('click', generateImage);

            elements.downloadBtn.addEventListener('click', () => {
                if (appState.generatedImages.length > 0) {
                    const imageUrl = appState.generatedImages[0].url;
                    const link = document.createElement('a');
                    
                    const tempImage = new Image();
                    tempImage.crossOrigin = 'Anonymous';
                    tempImage.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = tempImage.width;
                        canvas.height = tempImage.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(tempImage, 0, 0);
                        
                        link.href = canvas.toDataURL('image/png');
                        link.download = `generated-image-${Date.now()}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    };
                    tempImage.src = imageUrl;
                }
            });

            elements.saveHistoryBtn.addEventListener('click', () => {
                if (appState.generatedImages.length > 0) {
                    saveGeneratedImagesToHistory();
                    showToast('已保存到历史记录');
                }
            });

            elements.regenerateBtn.addEventListener('click', generateImage);

            elements.apiSettingBtn.addEventListener('click', () => {
                elements.apiModal.classList.remove('hidden');
                renderApiKeyList();
            });

            elements.closeApiModal.addEventListener('click', () => {
                elements.apiModal.classList.add('hidden');
            });

            elements.apiModal.addEventListener('click', (e) => {
                if (e.target === elements.apiModal) elements.apiModal.classList.add('hidden');
            });

            elements.addApiKeyBtn.addEventListener('click', addNewApiKey);

            elements.saveApiSetting.addEventListener('click', saveApiSettings);

            elements.clearHistoryBtn.addEventListener('click', () => {
                if (confirm('确定要清空所有历史记录吗？')) {
                    appState.historyImages = [];
                    appState.historyPage = 1;
                    saveHistory();
                    renderHistory();
                }
            });

            // 为所有可点击放大的图片添加事件监听
            document.addEventListener('click', function(e) {
                // 检查是否点击了可放大的图片
                if (e.target.classList.contains('zoomable-image')) {
                    const imgSrc = e.target.src;
                    elements.previewModalImg.src = imgSrc;
                    elements.imagePreviewModal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            });

            elements.closePreviewModal.addEventListener('click', () => {
                elements.imagePreviewModal.classList.add('hidden');
                document.body.style.overflow = '';
            });

            elements.imagePreviewModal.addEventListener('click', (e) => {
                if (e.target === elements.imagePreviewModal) {
                    elements.imagePreviewModal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });

            // 批量添加 API Key 功能
            elements.batchAddBtn.addEventListener('click', batchAddApiKeys);
            
            // 批量导出 API Key 功能
            elements.batchExportBtn.addEventListener('click', batchExportApiKeys);
            
            // 刷新积分按钮
            elements.refreshCredits.addEventListener('click', fetchAllApiCredits);
            
            // 页面卸载时停止轮询
            window.addEventListener('beforeunload', stopModelStatusPolling);
        }

        function updateBananaImageSizeVisibility() {
            // 只有当选择banana-pro时才显示图像大小选项
            if (appState.selectedBananaSubModel === 'nano-banana-pro') {
                elements.bananaImageSizeContainer.classList.remove('hidden');
            } else {
                elements.bananaImageSizeContainer.classList.add('hidden');
            }
        }

        function batchExportApiKeys() {
            // 过滤掉空的和无效的API Key
            const validApiKeys = appState.apiKeys
                .filter(api => api.key && api.key.startsWith('sk-'))
                .map(api => api.key);
            
            if (validApiKeys.length === 0) {
                showToast('没有有效的API Key可以导出', 'warning');
                return;
            }
            
            // 创建纯API Key内容，每行一个
            const exportContent = validApiKeys.join('\n');
            
            // 创建Blob对象并下载
            const blob = new Blob([exportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
            
            a.href = url;
            a.download = `yahee-api-keys-${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`成功导出 ${validApiKeys.length} 个API Key`, 'success');
        }

        function batchAddApiKeys() {
            const batchText = elements.batchApiKeys.value.trim();
            if (!batchText) {
                showToast('请输入至少一个 API Key', 'warning');
                return;
            }

            // 按行分割，过滤空行和无效格式
            const newKeys = batchText.split('\n')
                .map(key => key.trim())
                .filter(key => key && key.startsWith('sk-')); // 简单校验格式

            if (newKeys.length === 0) {
                showToast('未找到有效 API Key', 'warning');
                return;
            }

            // 去重（检查现有 Key）
            const existingKeys = new Set(appState.apiKeys.map(api => api.key));
            const addedKeys = newKeys.filter(key => !existingKeys.has(key));

            if (addedKeys.length === 0) {
                showToast('所有 API Key 已存在', 'info');
                return;
            }

            // 添加到现有列表
            addedKeys.forEach(key => {
                appState.apiKeys.push({ key, credits: 0 });
            });

            // 更新 UI
            renderApiKeyList();
            elements.batchApiKeys.value = ''; // 清空输入框
            showToast(`成功添加 ${addedKeys.length} 个新 API Key`, 'success');
        }

        function renderApiKeyList() {
            elements.apiKeyList.innerHTML = '';
            appState.apiKeys.forEach((apiKey, index) => {
                const apiKeyItem = document.createElement('div');
                apiKeyItem.className = `flex items-center gap-2 mb-2 p-2 border ${index === appState.selectedApiKeyIndex ? 'border-primary bg-primary/5' : 'border-gray-200'} rounded-lg`;
                apiKeyItem.innerHTML = `
                    <input type="password" class="flex-1 border-none outline-none" placeholder="sk-..." value="${apiKey.key}">
                    <span class="text-xs bg-gray-200 px-2 py-1 rounded">积分: ${apiKey.credits || '--'}</span>
                    <button class="text-danger hover:text-red-600 delete-api-key" data-index="${index}">
                        <i class="fa fa-trash"></i>
                    </button>
                `;
                elements.apiKeyList.appendChild(apiKeyItem);
            });

            document.querySelectorAll('.delete-api-key').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    deleteApiKey(index);
                });
            });
        }

        function addNewApiKey() {
            appState.apiKeys.push({ key: '', credits: 0 });
            renderApiKeyList();
        }

        function deleteApiKey(index) {
            if (appState.apiKeys.length <= 1) {
                showToast('至少需要保留一个API Key', 'warning');
                return;
            }
            appState.apiKeys.splice(index, 1);
            if (appState.selectedApiKeyIndex === index) {
                appState.selectedApiKeyIndex = 0;
            } else if (appState.selectedApiKeyIndex > index) {
                appState.selectedApiKeyIndex--;
            }
            renderApiKeyList();
        }

        function saveApiSettings() {
            const apiKeyInputs = elements.apiKeyList.querySelectorAll('input[type="password"]');
            appState.apiKeys = Array.from(apiKeyInputs).map(input => ({
                key: input.value.trim(),
                credits: 0
            })).filter(apiKey => apiKey.key);
            
            if (appState.apiKeys.length === 0) {
                appState.apiKeys.push({ key: '', credits: 0 });
            }
            
            if (appState.selectedApiKeyIndex >= appState.apiKeys.length) {
                appState.selectedApiKeyIndex = 0;
            }
            
            localStorage.setItem('apiKeys', JSON.stringify(appState.apiKeys));
            elements.apiModal.classList.add('hidden');
            showToast('API Key 已保存');
            fetchAllApiCredits();
            updateCreditStatistics();
        }

        async function fetchAllApiCredits() {
            for (let i = 0; i < appState.apiKeys.length; i++) {
                const apiKey = appState.apiKeys[i];
                if (apiKey.key) {
                    try {
                        const response = await fetch(`${BASE_URL}/client/common/getCredits?apikey=${apiKey.key}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.code === 0 && data.data) {
                                appState.apiKeys[i].credits = data.data.credits || 0;
                            }
                        }
                    } catch (error) {
                        console.error(`获取API Key ${i+1} 积分失败:`, error);
                    }
                }
            }
            filterLowCreditKeys();
            updateCreditDisplay();
            updateCreditStatistics();
            renderApiKeyList();
            localStorage.setItem('apiKeys', JSON.stringify(appState.apiKeys));
        }

        function filterLowCreditKeys() {
            const initialLength = appState.apiKeys.length;
            // 过滤积分低于400且非空的API Key
            appState.apiKeys = appState.apiKeys.filter(apiKey => apiKey.credits >= 400 || !apiKey.key);
            
            if (appState.apiKeys.length < initialLength) {
                showToast('积分低于400的API Key已自动删除', 'info');
                if (appState.selectedApiKeyIndex >= appState.apiKeys.length) {
                    appState.selectedApiKeyIndex = 0;
                }
            }
        }

        function updateCreditStatistics() {
            const validKeys = appState.apiKeys.filter(api => api.key && api.key.startsWith('sk-'));
            appState.validApiCount = validKeys.length;
            
            if (validKeys.length > 0) {
                const credits = validKeys.map(api => api.credits || 0);
                appState.totalCredits = credits.reduce((sum, credit) => sum + credit, 0);
                const maxCredit = Math.max(...credits);
                const minCredit = Math.min(...credits);
                
                // 更新模态框统计
                elements.validApiCount.textContent = appState.validApiCount;
                elements.modalTotalCredit.textContent = appState.totalCredits;
                elements.maxCredit.textContent = maxCredit;
                elements.minCredit.textContent = minCredit;
                
                // 更新顶部总积分显示
                elements.totalCreditCount.textContent = appState.totalCredits;
                elements.totalCredit.classList.remove('hidden');
                
                // 更新视觉提示
                updateCreditVisualHint();
            } else {
                // 没有有效API Key时的显示
                elements.validApiCount.textContent = '0';
                elements.modalTotalCredit.textContent = '0';
                elements.maxCredit.textContent = '0';
                elements.minCredit.textContent = '0';
                elements.totalCredit.classList.add('hidden');
                elements.creditStatus.innerHTML = '';
            }
        }
        
        function updateCreditVisualHint() {
            const currentKey = appState.apiKeys[appState.selectedApiKeyIndex];
            const currentCredit = currentKey.credits || 0;
            
            let statusIcon = '';
            let statusColor = '';
            let statusText = '';
            
            if (currentCredit >= 5000) {
                statusIcon = 'fa-check-circle';
                statusColor = 'text-success';
                statusText = '积分充足';
            } else if (currentCredit >= 1000) {
                statusIcon = 'fa-info-circle';
                statusColor = 'text-warning';
                statusText = '积分正常';
            } else if (currentCredit >= 400) {
                statusIcon = 'fa-exclamation-triangle';
                statusColor = 'text-warning';
                statusText = '积分较低';
            } else {
                statusIcon = 'fa-times-circle';
                statusColor = 'text-danger';
                statusText = '积分不足';
            }
            
            elements.creditStatus.innerHTML = `
                <i class="fa ${statusIcon} ${statusColor} mr-1"></i>
                <span class="${statusColor} text-xs">${statusText}</span>
            `;
            elements.creditStatus.classList.remove('hidden');
        }

        function updateCreditDisplay() {
            const currentKey = appState.apiKeys[appState.selectedApiKeyIndex];
            elements.creditCount.textContent = currentKey.credits || '--';
            updateCreditVisualHint();
        }

        function updateModelSelection(modelName) {
            elements.gptConfig.classList.add('hidden');
            elements.bananaConfig.classList.add('hidden');

            if (modelName === 'gpt') {
                elements.gptConfig.classList.remove('hidden');
            } else if (modelName === 'banana') {
                elements.bananaConfig.classList.remove('hidden');
                updateBananaImageSizeVisibility();
            }
        }

        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => 
                file.type.startsWith('image/') && appState.uploadedImages.length < 5
            );
            if (validFiles.length === 0) {
                showToast('请上传图片文件，且最多上传5张', 'warning');
                return;
            }
            validFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    appState.uploadedImages.push(imageUrl);
                    const previewItem = document.createElement('div');
                    previewItem.className = 'relative rounded overflow-hidden';
                    previewItem.innerHTML = `
                        <img src="${imageUrl}" alt="预览图" class="w-full h-20 object-cover zoomable-image">
                        <button class="absolute top-1 right-1 bg-danger/80 text-white rounded-full w-5 h-5 flex items-center justify-center hover:bg-danger" data-url="${imageUrl}">
                            <i class="fa fa-times text-xs"></i>
                        </button>
                    `;
                    previewItem.querySelector('button').addEventListener('click', (e) => {
                        const urlToRemove = e.currentTarget.dataset.url;
                        appState.uploadedImages = appState.uploadedImages.filter(url => url !== urlToRemove);
                        e.currentTarget.closest('div').remove();
                        if (appState.uploadedImages.length === 0) elements.previewContainer.classList.add('hidden');
                    });
                    elements.previewList.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
            elements.previewContainer.classList.remove('hidden');
        }

        function toggleTag(tag) {
            appState.selectedTags.has(tag) ? appState.selectedTags.delete(tag) : appState.selectedTags.add(tag);
            renderSelectedTags();
        }

        function renderSelectedTags() {
            elements.selectedTags.innerHTML = '';
            if (appState.selectedTags.size > 0) {
                elements.selectedTagsContainer.classList.remove('hidden');
                appState.selectedTags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'bg-primary/10 text-primary px-3 py-1 rounded-full text-sm flex items-center gap-1';
                    tagElement.innerHTML = `
                        ${tag}
                        <button class="ml-1 text-primary/70 hover:text-primary" data-tag="${tag}">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    `;
                    tagElement.querySelector('button').addEventListener('click', (e) => toggleTag(e.currentTarget.dataset.tag));
                    elements.selectedTags.appendChild(tagElement);
                });
            } else {
                elements.selectedTagsContainer.classList.add('hidden');
            }
        }

        function getFullPrompt() {
            const tagText = Array.from(appState.selectedTags).join(', ');
            const customText = elements.customPrompt.value.trim();
            return tagText ? `${customText ? `${customText}，` : ''}${tagText}` : customText;
        }

        const IMGBB_API_KEY = 'e8bf0d415745ca4f4ceee30dd5745e16';
        function uploadImageToServer(dataUrl) {
            const [header, base64Data] = dataUrl.split(',');
            const formData = new FormData();
            formData.append('image', base64Data);
            return fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error(`上传失败，HTTP状态码: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success && data.data && data.data.url) return data.data.url;
                else throw new Error('ImgBB API 返回格式不正确: ' + JSON.stringify(data));
            })
            .catch(error => {
                console.error('图片上传到 ImgBB 时出错:', error);
                throw error;
            });
        }

        function saveGeneratedImagesToHistory() {
            const currentPrompt = getFullPrompt();
            let modelName = appState.selectedModel;
            if (modelName === 'banana') {
                modelName += ` (${appState.selectedBananaSubModel})`;
            } else if (modelName === 'gpt') {
                 modelName += ` (sora-image)`;
            }

            appState.generatedImages.forEach(img => {
                appState.historyImages.unshift({
                    url: img.url,
                    prompt: currentPrompt,
                    model: modelName,
                    timestamp: new Date().toISOString()
                });
            });
            saveHistory();
            appState.historyPage = 1;
            renderHistory();
        }
        
        async function pollForResult(taskId, apiKey, timeout = 600000, initialInterval = 3000) {// 轮询10分钟
            const startTime = Date.now();
            let interval = initialInterval;
            const maxInterval = 10000; // 最大轮询间隔为10秒

            while (Date.now() - startTime < timeout) {
                // 等待当前间隔
                await new Promise(resolve => setTimeout(resolve, interval));

                // 动态调整轮询间隔，逐渐拉长
                if (interval < maxInterval) {
                    interval = Math.min(interval * 1.2, maxInterval);
                }

                try {
                    const response = await fetch(`${BASE_URL}/v1/draw/result`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({ id: taskId })
                    });
                    
                    if (!response.ok) {
                        // 如果HTTP状态码不是2xx，尝试解析错误信息
                        let errorMsg = `轮询结果失败: HTTP ${response.status}`;
                        try {
                            const errorData = await response.json();
                            if (errorData.msg) errorMsg += ` - ${errorData.msg}`;
                        } catch (e) { /* 忽略解析错误 */ }
                        throw new Error(errorMsg);
                    }

                    const result = await response.json();
                    
                    if (result.code === -22) {
                        // 任务ID不存在，可能已过期或被删除
                        throw new Error(`任务ID不存在或已过期: ${taskId}`);
                    }
                    else if (result.code !== 0 || !result.data) {
                        // API返回其他错误
                        throw new Error(`轮询API返回异常: ${result.msg || '无错误信息'}`);
                    }
                    
                    const taskData = result.data;
                    if (taskData.status === 'succeeded') {
                        return taskData;
                    } else if (taskData.status === 'failed') {
                        throw new Error(`任务失败: ${taskData.failure_reason || taskData.error || '未知错误'}`);
                    }
                    
                    // 更新进度UI
                    const progress = taskData.progress || Math.min(95, Math.round(((Date.now() - startTime) / timeout) * 100));
                    updateProgressUI(progress);

                } catch (error) {
                    console.error('轮询过程中发生错误:', error);
                    // 如果是任务不存在等致命错误，直接抛出
                    if (error.message.includes('任务ID不存在') || error.message.includes('HTTP 404')) {
                        throw error;
                    }
                    // 其他网络错误等，继续轮询
                    showToast(`轮询时出现临时错误: ${error.message}，将继续尝试...`, 'warning');
                }
            }
            
            // 超时后，提供详细的手动查询信息
            const manualQueryCmd = `curl -X POST ${BASE_URL}/v1/draw/result -H "Content-Type: application/json" -H "Authorization: Bearer ${apiKey}" -d '{"id": "${taskId}"}'`;
            
            throw new Error(
                `任务超时。请稍后使用任务ID手动查询结果。\n\n` +
                `任务ID: ${taskId}\n` +
                `手动查询命令: \`${manualQueryCmd}\``
            );
        }
        
        function updateProgressUI(progress) {
            elements.previewResult.innerHTML = `
                <div class="animate-pulse flex flex-col items-center justify-center">
                    <div class="w-16 h-16 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-4"></div>
                    <p class="text-secondary mb-2">生成中...</p>
                    <p class="text-xs text-gray-500">进度: ${progress}%</p>
                </div>
            `;
        }

        async function generateImage() {
            if (appState.apiKeys.length === 0 || !appState.apiKeys[0].key) {
                showToast('请先设置API Key', 'warning');
                elements.apiModal.classList.remove('hidden');
                return;
            }

            const prompt = getFullPrompt();
            if (!prompt && appState.uploadedImages.length === 0) {
                showToast('请至少提供提示词或参考图片', 'warning');
                return;
            }

            let currentApiKeyIndex = appState.selectedApiKeyIndex;
            let apiKey = appState.apiKeys[currentApiKeyIndex].key;
            let cost = getModelCost(appState.selectedModel);
            
            if (appState.apiKeys[currentApiKeyIndex].credits < cost) {
                currentApiKeyIndex = findNextAvailableApiKey(currentApiKeyIndex);
                if (currentApiKeyIndex === -1) {
                    showToast('所有API Key积分不足，请充值后再试', 'warning');
                    return;
                }
                appState.selectedApiKeyIndex = currentApiKeyIndex;
                apiKey = appState.apiKeys[currentApiKeyIndex].key;
                showToast(`当前API Key积分不足，已自动切换到第${currentApiKeyIndex + 1}个Key`, 'info');
            }

            elements.generateBtn.disabled = true;
            elements.generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 生成中...';
            elements.generationStatus.classList.remove('hidden');
            elements.resultActions.classList.add('hidden');
            updateProgressUI(0);

            try {
                const isGPTModel = appState.selectedModel === 'gpt';
                const isBananaModel = appState.selectedModel === 'banana';

                // 直接使用用户选择的比例，不再强制使用auto
                const actualSize = elements.imageSize.value;
                
                console.log('使用的图片比例:', actualSize);

                const requestData = {
                    prompt: prompt,
                    shutProgress: false,
                };

                if (appState.uploadedImages.length > 0) {
                    requestData.urls = await Promise.all(appState.uploadedImages.map(img => uploadImageToServer(img)));
                }
                
                let apiUrl;
                if (isGPTModel) {
                    apiUrl = `${BASE_URL}/v1/draw/completions`;
                    requestData.model = 'sora-image';
                    requestData.size = actualSize; // 使用用户选择的比例
                    requestData.variants = 1;
                    requestData.webHook = "-1";
                } else if (isBananaModel) {
                    // 更新Banana模型请求参数以支持Gemini官方接口格式
                    apiUrl = `${BASE_URL}/v1/draw/nano-banana`;
                    requestData.model = appState.selectedBananaSubModel;
                    requestData.aspectRatio = actualSize; // 使用用户选择的比例
                    requestData.shutProgress = false;
                    
                    // 只有pro模型支持imageSize参数
                    if (appState.selectedBananaSubModel === 'nano-banana-pro') {
                        requestData.imageSize = elements.bananaImageSize.value;
                    }
                    
                    // 使用webHook参数为"-1"以支持轮询方式获取结果
                    requestData.webHook = "-1";
                }

                console.log('发送的请求数据:', JSON.stringify(requestData, null, 2));

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestData)
                });

                let resultData = null;

                if (isGPTModel || isBananaModel) {
                    // GPT和Banana模型都使用轮询方式
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API 请求失败:', errorText);
                        throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                    }
                    const initialResponse = await response.json();
                    if (initialResponse.code === 0 && initialResponse.data && initialResponse.data.id) {
                        const taskId = initialResponse.data.id;
                        showToast(`任务已提交，ID: ${taskId}，开始轮询结果...`, 'info');
                        resultData = await pollForResult(taskId, apiKey);
                    } else {
                        throw new Error(`API 未能返回任务ID: ${initialResponse.msg || '未知错误'}`);
                    }
                }
                
                console.log('生成结果:', resultData);
                handleSuccessfulResult(resultData, currentApiKeyIndex);

            } catch (error) {
                console.error('生成图片时出错:', error);
                elements.previewResult.innerHTML = `
                    <i class="fa fa-exclamation-triangle text-warning text-5xl mb-3"></i>
                    <p class="text-danger mb-2">生成失败</p>
                    <p class="text-sm text-gray-500">${error.message.replace(/\n/g, '<br>')}</p>
                `;
            } finally {
                elements.generateBtn.disabled = false;
                elements.generateBtn.innerHTML = '<i class="fa fa-magic"></i><span>开始生成</span>';
                elements.generationStatus.classList.add('hidden');
            }
        }
        
        function handleSuccessfulResult(resultData, apiKeyIndex) {
            if (resultData.results && resultData.results.length > 0) {
                appState.generatedImages = resultData.results;
            } else if (resultData.url) {
                appState.generatedImages = [{ url: resultData.url }];
            } else {
                throw new Error('生成成功，但未返回有效图片URL。');
            }

            const imageUrl = appState.generatedImages[0].url;
            
            elements.previewResult.innerHTML = `
                <img src="${imageUrl}" alt="生成结果" class="max-w-full max-h-[300px] object-contain rounded-lg preview-shadow zoomable-image">
            `;
            elements.resultActions.classList.remove('hidden');
            
            deductCredit(apiKeyIndex, appState.selectedModel);
            saveGeneratedImagesToHistory();
            
            if (appState.generatedImages.length > 1) {
                showToast(`成功生成 ${appState.generatedImages.length} 张图片，已自动保存到历史记录。`, 'success');
            } else {
                showToast('图片生成成功，已自动保存到历史记录！', 'success');
            }
        }

        function getModelCost(model) {
            switch(model) {
                case 'gpt':
                    return 400; // GPT模型消耗400积分
                case 'banana':
                    // Banana模型根据子模型消耗不同积分
                    if (appState.selectedBananaSubModel === 'nano-banana-pro') return 3000;
                    if (appState.selectedBananaSubModel === 'nano-banana') return 1400;
                    return 1400; // 默认使用banana的积分
                default:
                    return 10;
            }
        }

        function deductCredit(apiKeyIndex, model) {
            const cost = getModelCost(model);
            appState.apiKeys[apiKeyIndex].credits = Math.max(0, appState.apiKeys[apiKeyIndex].credits - cost);
            updateCreditDisplay();
            updateCreditStatistics();
            localStorage.setItem('apiKeys', JSON.stringify(appState.apiKeys));
        }

        function findNextAvailableApiKey(currentIndex) {
            const cost = getModelCost(appState.selectedModel);
            for (let i = 0; i < appState.apiKeys.length; i++) {
                const index = (currentIndex + 1 + i) % appState.apiKeys.length;
                if (index !== currentIndex && appState.apiKeys[index].credits >= cost) {
                    return index;
                }
            }
            return -1;
        }

        function saveHistory() {
            localStorage.setItem('imageHistory', JSON.stringify(appState.historyImages));
        }

        function renderHistory() {
            const startIndex = (appState.historyPage - 1) * appState.historyPageSize;
            const endIndex = startIndex + appState.historyPageSize;
            const paginatedHistory = appState.historyImages.slice(startIndex, endIndex);
            
            if (appState.historyImages.length === 0) {
                elements.historyContainer.innerHTML = `
                    <div class="col-span-full text-center py-8 text-secondary">
                        <i class="fa fa-folder-open-o text-3xl mb-3"></i>
                        <p class="text-sm">暂无历史记录</p>
                    </div>
                `;
                return;
            }
            
            elements.historyContainer.innerHTML = '';
            paginatedHistory.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'relative rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition-shadow';
                historyItem.innerHTML = `
                    <img src="${item.url}" alt="历史记录 ${index + 1}" class="w-full h-16 object-cover zoomable-image">
                    <div class="absolute inset-0 bg-black/50 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center gap-1">
                        <button class="view-history bg-white/90 text-dark p-1 rounded-full hover:bg-white" data-item='${JSON.stringify(item)}'>
                            <i class="fa fa-eye text-xs"></i>
                        </button>
                        <button class="delete-history bg-white/90 text-danger p-1 rounded-full hover:bg-white" data-original-index="${startIndex + index}">
                            <i class="fa fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
                historyItem.querySelector('.view-history').addEventListener('click', (e) => {
                    const item = JSON.parse(e.currentTarget.dataset.item);
                    elements.previewResult.innerHTML = `
                        <img src="${item.url}" alt="历史记录" class="max-w-full max-h-[300px] object-contain rounded-lg preview-shadow zoomable-image">
                    `;
                    appState.generatedImages = [{ url: item.url }];
                    elements.resultActions.classList.remove('hidden');
                });
                historyItem.querySelector('.delete-history').addEventListener('click', (e) => {
                    const originalIndex = parseInt(e.currentTarget.dataset.originalIndex);
                    appState.historyImages.splice(originalIndex, 1);
                    
                    if (paginatedHistory.length === 1 && appState.historyPage > 1) {
                        appState.historyPage--;
                    }
                    
                    saveHistory();
                    renderHistory();
                });
                elements.historyContainer.appendChild(historyItem);
            });
            
            if (appState.historyImages.length > appState.historyPageSize) {
                const pagination = document.createElement('div');
                pagination.className = 'col-span-full flex justify-center mt-2 gap-1';
                
                if (appState.historyPage > 1) {
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'px-2 py-1 rounded border border-gray-300 hover:bg-gray-100 text-xs';
                    prevBtn.innerHTML = '<i class="fa fa-chevron-left"></i>';
                    prevBtn.addEventListener('click', () => {
                        appState.historyPage--;
                        renderHistory();
                    });
                    pagination.appendChild(prevBtn);
                }
                
                const pageInfo = document.createElement('span');
                pageInfo.className = 'px-2 py-1 text-xs';
                pageInfo.textContent = `${appState.historyPage} / ${Math.ceil(appState.historyImages.length / appState.historyPageSize)}`;
                pagination.appendChild(pageInfo);
                
                if (endIndex < appState.historyImages.length) {
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'px-2 py-1 rounded border border-gray-300 hover:bg-gray-100 text-xs';
                    nextBtn.innerHTML = '<i class="fa fa-chevron-right"></i>';
                    nextBtn.addEventListener('click', () => {
                        appState.historyPage++;
                        renderHistory();
                    });
                    pagination.appendChild(nextBtn);
                }
                
                elements.historyContainer.appendChild(pagination);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
            switch(type) {
                case 'success':
                    toast.classList.add('bg-success', 'text-white');
                    toast.innerHTML = `<i class="fa fa-check-circle mr-2"></i>${message}`;
                    break;
                case 'warning':
                    toast.classList.add('bg-warning', 'text-white');
                    toast.innerHTML = `<i class="fa fa-exclamation-triangle mr-2"></i>${message}`;
                    break;
                case 'error':
                    toast.classList.add('bg-danger', 'text-white');
                    toast.innerHTML = `<i class="fa fa-times-circle mr-2"></i>${message}`;
                    break;
                default:
                    toast.classList.add('bg-primary', 'text-white');
                    toast.innerHTML = `<i class="fa fa-info-circle mr-2"></i>${message}`;
            }
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
                toast.classList.add('translate-x-0');
            }, 100);
            setTimeout(() => {
                toast.classList.remove('translate-x-0');
                toast.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>